<!DOCTYPE html>
<html>
<head>
    <title>Kviz Priprema üõ†Ô∏è</title>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #e0e0e0; padding: 20px; }
        
        /* Navigacija */
        .nav { background: #333; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: flex; gap: 10px; align-items: center;}
        .nav a { color: white; text-decoration: none; padding: 10px; font-weight: bold; }
        .nav a.active { background: #555; border-radius: 4px; }
        .quiz-manager-btn { background: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 20px;}
        
        /* HEADER */
        .quiz-header { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header-group { flex: 1; }
        .header-label { font-size: 0.8em; color: #777; display: block; margin-bottom: 2px;}
        .quiz-input { font-size: 1.3em; font-weight: bold; border: 1px solid #ddd; width: 100%; padding: 5px; border-radius: 4px;}
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 500px; padding: 20px; border-radius: 10px; max-height: 80vh; overflow-y: auto; }
        .quiz-list-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .quiz-list-item:hover { background: #f9f9f9; }
        .quiz-list-item.active-item { background: #e8f8f5; border-left: 5px solid #1abc9c; }
        .btn-new { width: 100%; padding: 15px; background: #2ecc71; color: white; border: none; font-size: 1.1em; cursor: pointer; margin-bottom: 10px; border-radius: 5px;}
        
        /* Standard Styles */
        .rounds-bar { display: flex; gap: 5px; margin-bottom: 15px; }
        .round-tab { padding: 10px 20px; background: #95a5a6; color: white; border: none; cursor: pointer; border-radius: 5px; font-weight: bold; flex: 1; transition: 0.2s;}
        .round-tab.active-round { background: #2c3e50; border-bottom: 4px solid #f1c40f; transform: translateY(-2px);}
        
        .container { display: flex; gap: 20px; height: 75vh; }
        .column { flex: 1; background: white; padding: 15px; border-radius: 8px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* PJESME I DRAG HANDLE */
        .song-item { border-bottom: 1px solid #eee; padding: 8px; display: flex; justify-content: space-between; align-items: center; background: white; }
        .song-item.hidden-round { display: none !important; }
        .drag-handle { cursor: grab; color: #bbb; padding: 10px; font-size: 1.2em; user-select: none; margin-right: 5px; }
        .drag-handle:active { cursor: grabbing; color: #333; }
        .sortable-ghost { opacity: 0.4; background: #f0f0f0; border: 2px dashed #ccc;}
        
        .edit-input { padding: 5px; border: 1px solid #3498db; width: 120px; display: none; }
        .display-text { display: inline; }
        .editing .edit-input { display: inline-block; }
        .editing .display-text { display: none; }
        .btn-icon, .btn-add, .btn-del { cursor: pointer; border: none; padding: 5px; border-radius: 4px; margin-left: 2px;}
        .btn-add { background: #2980b9; color: white; } .btn-del { background: #c0392b; color: white; }
        .editing .btn-save { display: inline-block; } .btn-save { display: none; } .editing .btn-edit { display: none; }

        /* PLAYER */
        #bigPreviewContainer { position: fixed; bottom: 0; left: 0; width: 100%; height: 220px; background: #1a1a1a; color: #eee; display: none; flex-direction: column; z-index: 9999; }
        .waveform-wrapper { flex-grow: 1; background: #000; } #waveform { width: 100%; height: 100%; }
        .preview-controls { height: 50px; background: #2a2a2a; display: flex; align-items: center; padding: 0 20px; gap: 15px; }
        .volume-control { display: flex; align-items: center; gap: 5px; margin-left: auto; margin-right: 20px;}
        .volume-slider { cursor: pointer; width: 100px; accent-color: #00d2ff; }
    </style>
</head>
<body>

    <div class="nav">
        <a href="/admin/setup" class="active">üõ†Ô∏è PRIPREMA</a>
        <a href="/admin/live">üé§ U≈ΩIVO (LIVE)</a>
        <button class="quiz-manager-btn" onclick="openManager()">üìÇ Moji Kvizovi</button>
        <a href="/" style="margin-left: auto;">üè† Poƒçetna</a>
    </div>

    <div class="quiz-header">
        <div class="header-group" style="flex: 2;">
            <span class="header-label">Naziv Kviza:</span>
            <input type="text" id="quizTitle" class="quiz-input" value="{{ quiz.info.title }}" onblur="saveInfo()">
        </div>
        <div class="header-group" style="flex: 1;">
            <span class="header-label">Datum odr≈æavanja:</span>
            <input type="date" id="quizDate" class="quiz-input" value="{{ quiz.info.date }}" onblur="saveInfo()">
        </div>
    </div>

    <div id="quizManagerModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2>üìÇ Odaberi Kviz</h2>
                <button onclick="document.getElementById('quizManagerModal').style.display='none'" style="cursor:pointer; background:none; border:none; font-size:1.5em;">‚úñ</button>
            </div>
            <button class="btn-new" onclick="createNewQuiz()">‚ûï KREIRAJ NOVI KVIZ</button>
            <div id="quizListContainer">Uƒçitavanje...</div>
        </div>
    </div>

    <div class="rounds-bar">
        <button class="round-tab active-round" onclick="selectRound(1)">1. Krug</button>
        <button class="round-tab" onclick="selectRound(2)">2. Krug</button>
        <button class="round-tab" onclick="selectRound(3)">3. Krug</button>
        <button class="round-tab" onclick="selectRound(4)">4. Krug</button>
        <button class="round-tab" onclick="selectRound(5)">5. Krug</button>
    </div>

    <div class="container">
        <div class="column">
            <h3 id="playlistHeader">üìù Playlist - 1. Krug</h3>
            <div id="playlistContainer">
                {% for song in quiz.songs %}
                <div class="song-item" id="song-row-{{ song.id }}" data-id="{{ song.id }}" data-round="{{ song.round }}">
                    <div class="drag-handle">‚ò∞</div>
                    
                    <div style="flex-grow: 1;">
                        <span style="background:#eee; padding:2px 5px; font-size:0.8em;">#{{ song.id }}</span>
                        <span class="display-text" id="disp-artist-{{ song.id }}">{{ song.artist }}</span>
                        <input type="text" class="edit-input" id="input-artist-{{ song.id }}" value="{{ song.artist }}"> - 
                        <span class="display-text" id="disp-title-{{ song.id }}">{{ song.title }}</span>
                        <input type="text" class="edit-input" id="input-title-{{ song.id }}" value="{{ song.title }}">
                        <br><small>({{ song.start_time }}s - {{ song.duration }}s)</small>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <button class="btn-icon" onclick="previewSong('{{ song.filename }}', {{ song.start_time }}, {{ song.duration }})">‚ñ∂Ô∏è</button>
                        <button class="btn-icon btn-edit" onclick="enableEdit({{ song.id }})">‚úèÔ∏è</button>
                        <button class="btn-icon btn-save" onclick="saveEdit({{ song.id }})">üíæ</button>
                        <button class="btn-del" onclick="removeSong({{ song.id }})">üóëÔ∏è</button>
                    </div>
                </div>
                {% endfor %}
            </div>   
        </div>

        <div class="column">
            <h3>üìÇ Datoteke</h3>
            <div style="background:#eee; padding:10px; margin-bottom:10px;">
                Map: <strong>{{ current_path }}</strong> <button onclick="changeFolder()">Promijeni</button> <button onclick="loadFiles()">Osvje≈æi</button>
            </div>
            <div>Start: <input type="number" id="defStart" value="30" style="width:40px">s Dur: <input type="number" id="defDur" value="15" style="width:40px">s</div>
            <div style="background: #e8f8f5; padding: 5px; margin-bottom: 10px; border-left: 3px solid #1abc9c;">Dodajem u: <strong id="addingToRoundText">1. Krug</strong></div>
            <div id="fileList">...</div>
        </div>
    </div>

    <div id="bigPreviewContainer">
        <div class="waveform-wrapper"><div id="waveform"></div></div>
        <div class="preview-controls">
            <button onclick="wavesurfer.playPause()" style="background:none; border:none; color:white; font-size:2em; cursor:pointer;">‚èØÔ∏è</button>
            <span id="wsCurrentTime">0:00</span> / <span id="wsTotalTime">0:00</span>
            
            <div class="volume-control">
                üîä 
                <input type="range" id="wsVolume" class="volume-slider" min="0" max="1" step="0.05" value="0.2">
            </div>
            
            <span id="previewTitle" style="color:#aaa; margin-right:20px;"></span>
            <button onclick="closeBigPreview()" style="background:#c0392b; color:white; border:none; padding:5px 10px;">X</button>
        </div>
    </div>

    <script>
        let wavesurfer, wsRegions, sortable, currentActiveRound = 1;

        document.addEventListener('DOMContentLoaded', function() {
            selectRound(1);
            
            // WAVESURFER SETUP
            wsRegions = WaveSurfer.Regions.create();
            wavesurfer = WaveSurfer.create({
                container: '#waveform', waveColor: '#555', progressColor: '#00d2ff', cursorColor: '#fff',
                height: 'auto', normalize: true, plugins: [wsRegions], backend: 'MediaElement'
            });
            wavesurfer.on('audioprocess', updateTimer); wavesurfer.on('seek', updateTimer); wavesurfer.on('ready', updateTimer);
            
            // POSTAVLJANJE DEFAULT GLASNOƒÜE NA 20%
            wavesurfer.setVolume(0.2); 
            
            // Slider logika
            document.getElementById('wsVolume').addEventListener('input', function() { wavesurfer.setVolume(this.value); });
            
            loadFiles();

            // SORTABLE (Drag & Drop) SETUP
            const el = document.getElementById('playlistContainer');
            sortable = Sortable.create(el, {
                handle: '.drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) { saveNewOrder(); }
            });
        });

        // --- SORTIRANJE FUNKCIJA ---
        async function saveNewOrder() {
            const items = document.querySelectorAll('.song-item:not(.hidden-round)');
            const newOrderIds = [];
            items.forEach(item => newOrderIds.push(item.getAttribute('data-id')));
            
            await fetch('/admin/reorder_songs', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ round: currentActiveRound, order: newOrderIds })
            });
            console.log("Redoslijed spremljen");
        }

        // --- QUIZ MANAGER ---
        function openManager() { document.getElementById('quizManagerModal').style.display = 'flex'; loadQuizList(); }
        async function loadQuizList() {
            const res = await fetch('/admin/list_quizzes'); const quizzes = await res.json();
            const c = document.getElementById('quizListContainer'); c.innerHTML = '';
            quizzes.forEach(q => {
                const d = document.createElement('div'); d.className = `quiz-list-item ${q.is_active ? 'active-item' : ''}`;
                d.innerHTML = `<div><div style="font-weight:bold;">${q.title}</div><small>${q.date||''} | ${q.filename}</small></div><div>${!q.is_active ? `<button onclick="deleteQuiz('${q.filename}')" style="background:#c0392b;color:white;border:none;">üóëÔ∏è</button>` : '<span style="color:green">AKTIVAN</span>'}</div>`;
                d.onclick=(e)=>{if(e.target.tagName!=='BUTTON') switchQuiz(q.filename);}; c.appendChild(d);
            });
        }
        async function createNewQuiz() { const t = prompt("Naziv:", "Novi Kviz"); if(t) { await fetch('/admin/create_quiz', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title:t, date:new Date().toISOString().split('T')[0]})}); location.reload(); }}
        async function switchQuiz(f) { await fetch('/admin/switch_quiz', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({filename:f})}); location.reload(); }
        async function deleteQuiz(f) { if(confirm("Obrisati?")) { await fetch('/admin/delete_quiz', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({filename:f})}); loadQuizList(); }}
        async function saveInfo() { await fetch('/admin/save_quiz_info', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title:document.getElementById('quizTitle').value, date:document.getElementById('quizDate').value})}); }

        // --- STANDARD FUNKCIJE ---
        function selectRound(r) {
            currentActiveRound = r;
            document.querySelectorAll('.round-tab').forEach((b, i) => b.classList.toggle('active-round', i+1===r));
            document.getElementById('playlistHeader').innerText = `üìù Playlist - ${r}. Krug`;
            document.getElementById('addingToRoundText').innerText = `${r}. Krug`;
            document.querySelectorAll('.song-item').forEach(s => s.classList.toggle('hidden-round', parseInt(s.dataset.round)!==r));
        }

        async function add(fn, art, tit) {
            await fetch('/admin/add_song', {method:'POST', headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({filename:fn, artist:art, title:tit, start_time:document.getElementById('defStart').value, duration:document.getElementById('defDur').value, round:currentActiveRound})});
            location.reload();
        }
        
        async function changeFolder() { const res = await fetch('/admin/select_folder', {method:'POST'}); if((await res.json()).status==='ok') location.reload(); }
        async function loadFiles() {
            const d = document.getElementById('fileList'); d.innerHTML='Uƒçitavanje...';
            const res = await fetch('/admin/scan_files'); const files = await res.json(); d.innerHTML='';
            files.forEach(f => {
                const sFn = f.filename.replace(/'/g, "\\'"), sAr = f.artist.replace(/'/g, "\\'"), sTi = f.title.replace(/'/g, "\\'");
                d.innerHTML += `<div class="song-item"><div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:60%;"><small>${f.filename}</small></div><div><button class="btn-icon" onclick="previewSong('${sFn}')">‚ñ∂Ô∏è</button><button class="btn-add" onclick="add('${sFn}','${sAr}','${sTi}')">‚ûï</button></div></div>`;
            });
        }
        async function removeSong(id) { if(confirm('Obrisati?')) { await fetch('/admin/remove_song', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:id})}); document.getElementById('song-row-'+id).remove(); }}
        function enableEdit(id) { document.getElementById('song-row-'+id).classList.add('editing'); }
        async function saveEdit(id) { await fetch('/admin/update_song', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:id, artist:document.getElementById('input-artist-'+id).value, title:document.getElementById('input-title-'+id).value})}); location.reload(); }

        // --- PLAYER FUNKCIJE ---
        function formatTime(s) { if(!s)return "0:00"; let m=Math.floor(s/60),sc=Math.floor(s%60); return m+":"+(sc<10?"0":"")+sc; }
        function updateTimer() { document.getElementById('wsCurrentTime').innerText=formatTime(wavesurfer.getCurrentTime()); document.getElementById('wsTotalTime').innerText=formatTime(wavesurfer.getDuration()); }
        
        async function previewSong(fn, st=null, du=null) {
            document.getElementById('bigPreviewContainer').style.display='flex';
            document.getElementById('previewTitle').innerText = fn;
            wsRegions.getRegions().forEach(r=>r.remove()); wavesurfer.stop();
            
            try {
                await wavesurfer.load(`/stream_song/${encodeURIComponent(fn)}`);
                // RESETIRAJ GLASNOƒÜU NA SLIDER (0.2)
                wavesurfer.setVolume(document.getElementById('wsVolume').value);
                
                if(st!==null){ const e=parseFloat(st)+parseFloat(du); wsRegions.addRegion({start:parseFloat(st), end:e, color:'rgba(46,204,113,0.4)', drag:false}); wavesurfer.setTime(parseFloat(st)); }
                wavesurfer.play();
            } catch(e) {alert('Error loading song');}
        }
        function closeBigPreview() { wavesurfer.stop(); document.getElementById('bigPreviewContainer').style.display='none'; }
    </script>
</body>
</html>