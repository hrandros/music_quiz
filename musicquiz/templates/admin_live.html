{% extends "base.html" %}
{% block title %}LIVE • Rock Quiz{% endblock %}

{% block nav %}
<div class="container">
  <a class="navbar-brand fw-bold text-white"
     href="{{ url_for('public.index') }}"
     style="font-family: 'Oswald'; font-size: 1.5rem; letter-spacing: 1px;">
    <i class="bi bi-lightning-charge-fill text-danger me-1" aria-hidden="true"></i>
    ROCK<span class="text-danger">QUIZ</span>
  </a>

  <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navContent">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div id="navContent" class="collapse navbar-collapse">
    <ul class="navbar-nav ms-auto gap-2 text-uppercase fw-bold" style="font-family: 'Oswald';">
      <li class="nav-item ms-lg-3">
        <a class="btn btn-sm btn-outline-light rounded-0 px-3" href="{{ url_for('admin.admin_setup') }}" target="_blank">
          <i class="bi bi-tools me-1" aria-hidden="true"></i> Setup
        </a>
      </li>
      <li class="nav-item">
        <a class="btn btn-sm btn-danger rounded-0 px-3" href="{{ url_for('screen.screen') }}" target="_blank">
          <i class="bi bi-tv me-1" aria-hidden="true"></i> TV Screen
        </a>
      </li>
    </ul>
  </div>
</div>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4 bg-black p-3 rounded shadow-sm border border-secondary">
  <div class="d-flex align-items-center gap-4">
    <h2 class="text-white mb-0">LIVE <span class="text-danger">●</span></h2>
    
    <div class="input-group input-group-sm" style="width: 300px;">
      <label class="input-group-text bg-dark text-secondary border-secondary">KVIZ:</label>
      <select id="liveQuizSwitcher" class="form-select bg-black text-warning border-secondary fw-bold" onchange="adminSwitchQuiz(this.value)">
        {% if all_quizzes %}
          {% for q in all_quizzes %}
            {% if q.event_date %}
              {% set date_display = q.event_date.strftime('%d.%m.%Y') %}
            {% else %}
              {% set date_display = '' %}
            {% endif %}
            <option value="{{ q.id }}" {% if q.id == quiz.id %}selected{% endif %}>
              {{ date_display }} - {{ q.title }}
            </option>
          {% endfor %}
        {% else %}
          <option value="0">Nema kvizova</option>
        {% endif %}
      </select>
    </div>
  </div>

  <div class="d-flex gap-2">
      <button id="reg-toggle-btn" class="btn btn-info fw-bold px-4" onclick="toggleRegistrations()">
          <i class="bi bi-unlock-fill me-2"></i>OTVORI PRIJAVE
      </button>
  </div>
</div>

<div class="container-fluid">
  <div class="row g-3">
    
    <div class="col-md-3">
      <div class="card bg-dark border-secondary h-100 shadow">
        <div class="card-header bg-black text-white d-flex justify-content-between align-items-center py-2">
          <span class="small fw-bold text-uppercase">Prijava Timova (<span id="playerCount">0</span>)</span>
          <i class="bi bi-people-fill text-danger"></i>
        </div>
        <div class="card-body p-0 overflow-auto" style="max-height: 75vh;">
          <table class="table table-dark table-hover mb-0">
            <tbody id="playerListBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card bg-dark border-danger h-100 shadow">
        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center py-2">
          <span class="fw-bold text-uppercase">Odgovori Uživo - Runda <span id="gradingRoundNum">1</span></span>
          <button class="btn btn-sm btn-light fw-bold px-3" onclick="LIVE.finalizeRound()">ZAKLJUČI BODOVE</button>
        </div>
        <div class="card-body p-0 overflow-auto" style="max-height: 75vh;">
          <table class="table table-dark table-striped align-middle mb-0">
            <thead class="sticky-top bg-dark shadow-sm">
              <tr class="small text-muted text-uppercase">
                <th class="ps-3">Tim</th>
                <th>Izvođač</th>
                <th>Naslov</th>
              </tr>
            </thead>
            <tbody id="gradingBody">
              </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-3">

      <div id="pjesme-data" style="display: none;">
        <table>
          {% for s in all_songs %}
          <tr class="song-row" 
              id="row-{{ s.id }}" 
              data-id="{{ s.id }}" 
              data-round="{{ s.round_number }}"
              data-artist="{{ s.artist }}"
              data-title="{{ s.title }}">
          </tr>
          {% endfor %}
        </table>
      </div>

      <div class="card bg-dark border-secondary mb-3 shadow">
        <div class="card-header small fw-bold text-muted text-center py-1">RUNDE</div>
        <div class="card-body p-2 d-flex flex-wrap gap-1 justify-content-center">
          {% for r in range(1, 6) %}
          <button class="btn btn-sm btn-outline-light round-tab" onclick="selectRound({{ r }})">{{ r }}</button>
          {% endfor %}
        </div>
      </div>

      <div class="card bg-black border-warning mb-3 shadow">
        <div class="card-header bg-warning text-dark fw-bold small py-1 text-center">REPRODUKCIJA</div>
        <div class="card-body p-3 text-center">
          <div id="np-artist" class="fw-bold text-warning mb-0">Nema aktivne pjesme</div>
          <div id="np-title" class="text-white small mb-3">---</div>
          <button id="btn-autoplay" class="btn btn-lg btn-outline-danger w-100" onclick="toggleAutoplay()">
            <i class="bi bi-play-circle-fill me-2"></i>KRENI KVIZ
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="dj-console" class="fixed-bottom bg-black border-top border-danger p-3" style="display:none; z-index: 1050;">
  <div class="row align-items-center">
    <div class="col-4 text-white">
      <div id="np-artist-mini" class="fw-bold"></div>
      <div id="np-title-mini" class="small text-danger"></div>
    </div>
    <div class="col-4 text-center">
      <button class="btn btn-lg btn-danger rounded-circle shadow" onclick="stopMusic()">
        <i class="bi bi-stop-fill"></i>
      </button>
    </div>
    <div class="col-4">
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-volume-up text-white"></i>
        <input type="range" class="form-range" id="vol" max="1" step="0.1" value="0.8" oninput="setVol(this.value)">
      </div>
    </div>
  </div>
  <audio id="audioPlayer"></audio>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin_live.js') }}"></script>
<script>
    // Dodatna logika za gumb prijava koju smo ranije dogovorili
    let registrationsOpen = false;
    function toggleRegistrations() {
        registrationsOpen = !registrationsOpen;
        const btn = document.getElementById('reg-toggle-btn');
        if(registrationsOpen) {
            btn.classList.replace('btn-info', 'btn-success');
            btn.innerHTML = '<i class="bi bi-lock-fill me-2"></i>ZATVORI PRIJAVE';
            socket.emit('admin_toggle_registrations', { open: true });
        } else {
            btn.classList.replace('btn-success', 'btn-info');
            btn.innerHTML = '<i class="bi bi-unlock-fill me-2"></i>OTVORI PRIJAVE';
            socket.emit('admin_toggle_registrations', { open: false });
        }
    }
</script>
{% endblock %}